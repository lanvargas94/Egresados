server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;
  
  # Configuración de charset UTF-8 para toda la aplicación
  charset utf-8;
  source_charset utf-8;
  
  # Permitir archivos grandes (hasta 2MB)
  client_max_body_size 2M;

  # Proxy backend-served uploads (news attachments/images) - DEBE ir ANTES de location /
  location /uploads/ {
    proxy_pass http://backend:8080/uploads/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Proxy Swagger UI and OpenAPI docs - DEBE ir ANTES de location / para evitar que Angular capture estas rutas
  location ~ ^/(swagger-ui|swagger-ui\.html|v3/api-docs|swagger) {
    proxy_pass http://backend:8080$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Headers adicionales para Swagger UI
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
  }
  
  # Proxy recursos estáticos de Swagger (CSS, JS, etc.)
  location ~ ^/(webjars|swagger-resources) {
    proxy_pass http://backend:8080$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Proxy API to backend service inside the compose network
  location /api/ {
    proxy_pass http://backend:8080/api/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Headers UTF-8 para el proxy
    proxy_set_header Accept-Charset "utf-8";
    # Permitir archivos grandes en el proxy
    client_max_body_size 2M;
  }

  # Optional: static caching (solo para archivos estáticos del frontend, no uploads)
  location ~* ^/(?!uploads).*\.(?:js|css|png|jpg|jpeg|gif|svg|ico)$ {
    expires 7d;
    access_log off;
  }

  location / {
    try_files $uri $uri/ /index.html;
    # Asegurar charset UTF-8 en todas las respuestas
    add_header Content-Type "text/html; charset=utf-8" always;
  }
  
  # Headers UTF-8 para archivos estáticos JSON
  location ~* \.json$ {
    add_header Content-Type "application/json; charset=utf-8" always;
    charset utf-8;
  }
}
